#! /bin/bash

set -e

function defaultgo {
	go $@\
		code.google.com/p/tasked/auth\
		code.google.com/p/tasked
}

function selfcert {
	key= cert=
	while :
	do
		case $1 in
		-key) shift; key=$1;;
		-cert) shift; cert=$1;;
		"") break;;
		*) shift;;
		esac
	done
	if [ ! "$key" -o ! "$cert" ]; then
		echo 'tsk selfcert -key <key-output-path> -cert <cert-output-path>'
		exit 1
	fi
	mkdir -p $(dirname $key)
	mkdir -p $(dirname $cert)
	openssl req -new -x509 -days 1095 -nodes -out "$cert" -keyout "$key"
}

function test {
	long=""
	if [ "$1" == -long ]; then
		long="-test.long"
	fi
	go test code.google.com/p/tasked/auth $long
	go test -i code.google.com/p/tasked
	go test code.google.com/p/tasked
	chmod -Rf o+r+w+X $testdata
}

case $1 in
selfcert)
	selfcert $@;;
test)
	shift
	test $@;;
*)
	defaultgo $@;;
esac
